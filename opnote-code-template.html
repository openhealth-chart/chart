<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Opnote-Generator</title>
    <meta name="description" content="Opnote Generator">
    <link rel="stylesheet" href="{{assetsUriBase}}/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli&amp;display=swap">
    <style>
        textarea {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
        };
        body.loading::after {
    content: 'Loading...';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2em;
    z-index: 1000;
      }
      details {
            margin: 1em 0;
            border: 1px solid #aaa;
            padding: 0.5em;
            border-radius: 0.25em;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
        }
        .conversation {
            max-width: fit-content;
            margin: 20px auto;
        }
        .question, .response {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .question {
            background-color: #f1f1f1;
        }
        .response {
            background-color: #e1f5fe;
        }
    </style>
</head>

<body style="background: linear-gradient(9deg, rgba(0,0,0,0.12) 0%, white 100%)">
    <!-- , url(&quot;{{assetsUriBase}}/img/DALL-E-OR.webp&quot;); -->
    <p style="text-align: center;color: var(--bs-emphasis-color);background: var(--bs-body-bg);">Disclaimer: This is a demonstration application. Do not use actual patient information!</p>
    <h2>Opnote: {{context.patient.name.[0].family}}, {{context.patient.name.[0].given.[0]}}-{{context.patient.id}}</h2>
    <h2>AI Coding Results</h2>
    <table>
        <thead>
          <tr>
           <th>ICD10 Code</th>
           <th>Description</th>
          </tr>
        </thead>
        <tbody>
            {{#each context.AICoding.icd10_codes}}
            <tr>
                <td><input type="checkbox" name="icd10_codes" value="{{this.code}}" checked></td>
                <td>{{this.code}}</td>
                <td>{{this.description}}</td>
            </tr>
        {{/each}}
        </tbody>
</table>
     <table>
            <thead>
              <tr>
               <th>CPT Code</th>
               <th>Description</th>
              </tr>
            </thead>
            <tbody>
                {{#each context.AICoding.cpt_codes}}
                <tr>
                    <td><input type="checkbox" name="cpt_codes" value="{{this.code}}" checked></td>
                    <td>{{this.code}}</td>
                    <td>{{this.description}}</td>
                </tr>
            {{/each}}
            </tbody>
    </table>
    <h3>Coding Comment</h3> 
    <p>{{context.AICoding.comment}}</p>
    <details>
        <summary>Click to ask a coding question</summary>
        <div class="conversation" id="conversation"></div>
         <form id="codingSubmit">
            <textarea id="codingQuestion" name="codingQuestion" rows="1" placeholder="Ask a coding question"></textarea>
            <input class="btn btn-primary" type="submit">
         </form>
    </details>  
    <form id="submitForm">
          <label class="form-label" for="op_date">Operative Date</label>
        <input class="form-control" id="op_date" style="color: var(--bs-emphasis-color);" name="op_date" type="date" value="{{body.op_date}}">
          <label class="form-label" for="surgeon">Surgeon</label>
        <input class="form-control" type="text" id="surgeon" name="surgeon" value="{{body.surgeon}}">
          <label class="form-label" for="assistant">Assistant</label>
        <input class="form-control" type="text" id="assistant" name="assistant" value="{{body.assistant}}">
          <label class="form-label" for="preop_diagnoses">Pre Operative Diagnoses</label>
        <input class="form-control" type="text" id="preop_diagnoses" name="preop_diagnoses" value="{{body.preop_diagnoses}}">
          <label class="form-label" for="postop_diagnoses">Post Operative Diagnoses</label>
        <input class="form-control" type="text" id="postop_diagnoses" name="postop_diagnoses" value="{{body.postop_diagnoses}}">
          <label class="form-label" for="procedures">Procedures</label>
        <textarea id="procedures" name="procedures" rows="1" placeholder="Procedure (one per line)...">{{body.procedures}}</textarea>
          <label class="form-label" for="anaethesia">Anaesthesia</label>
        <select id="anaesthesia" name="anaesthesia">
            <option value="general">General Anaesthesia</option>
            <option value="local">Local Anaesthesia</option>
            <option value="regional">Regional Anaesthesia</option>
            <option value="sedation">Sedation</option>
        </select>
          <label class="form-label" for="indications">Indications</label>
        <textarea id="indications" name="indications">{{body.indications}}</textarea>
          <label class="form-label" for="description">Description of Procedure</label>
        <textarea id="description" name="description">{{body.description}}</textarea>
        <input class="btn btn-primary" type="submit">
    </form>
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('submitForm').addEventListener('submit', function(event) {
        event.preventDefault();
        submitForm(this, '{{location}}');
    });

    document.getElementById('codingSubmit').addEventListener('submit', function(event) {
        event.preventDefault();
        submitCodingQuestion(this, '{{location}}coding');
    });

    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', autoResize);
        textarea.style.height = textarea.scrollHeight + 'px';
    });
});

function submitForm(form, url) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const procedures = document.getElementById('procedures');
    const proceduresList = procedures.value.split(/[\n,]/).filter(line => line.trim() !== '');
    data.procedures = (proceduresList.length > 1) ? proceduresList : [data.procedures];
// Collect selected ICD10 and CPT codes
    const selectedICD10Codes = Array.from(document.querySelectorAll('input[name="icd10_codes"]:checked')).map(checkbox => checkbox.value);
    const selectedCPTCodes = Array.from(document.querySelectorAll('input[name="cpt_codes"]:checked')).map(checkbox => checkbox.value);

    data.icd10_codes = selectedICD10Codes;
    data.cpt_codes = selectedCPTCodes;
   
    console.log("submitting to " + url + ":", JSON.stringify(data));
    document.body.classList.add('loading');

    fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer {{accessToken}}',
            'X-Chart-Task': '{{context.taskId}}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.text())
    .then(html => {
        document.open();
        document.write(html);
        document.close();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    })
    .finally(() => {
        document.body.classList.remove('loading');
    });
}

function submitCodingQuestion(form, url) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log("submitting to " + url + ":", JSON.stringify(data));
    const conversation = document.getElementById('conversation');

// Append user's question
    const questionElement = document.createElement('p');
    questionElement.className = 'question';
    questionElement.textContent = form.codingQuestion.value;
    conversation.appendChild(questionElement);
    document.getElementById('codingQuestion').value = '';
    document.body.classList.add('loading');

    fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer {{accessToken}}',
            'X-Chart-Task': '{{context.taskId}}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const responseText = result.answer; // Adjust according to your API response structure
        const responseElement = document.createElement('p');
        responseElement.className = 'response';
        responseElement.textContent = responseText;
        conversation.appendChild(responseElement);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    })
    .finally(() => {
        document.body.classList.remove('loading');
    });
}

function autoResize(e) {
    e.target.style.height = 'auto';
    e.target.style.height = (e.target.scrollHeight) + 'px';
    e.target.scrollTop = e.target.scrollHeight - e.target.clientHeight; 
}
        </script>
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{assetsUriBase}}/js/new-age.js"></script>
</body>

</html>